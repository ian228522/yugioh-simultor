<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yu-Gi-Oh! 起手期望與條件機率（動點／手坑／成金／其他）</title>
<style>
  :root{
    --bg:#0f1220; --card:#181c2f; --text:#e6eaf2; --muted:#9aa4bf;
    --acc:#7dd3fc; --good:#34d399; --warn:#f59e0b; --bad:#f87171;
    --btn:#222743; --border:#2a3157;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
  header{padding:22px 16px;text-align:center;border-bottom:1px solid var(--border);
         background:linear-gradient(180deg,rgba(125,211,252,.08),transparent)}
  h1{margin:0;font-size:clamp(20px,2.4vw,28px);letter-spacing:.5px}
  p.sub{margin:.5rem 0 0;color:var(--muted)}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:960px){.grid{grid-template-columns:380px 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  label{display:flex;align-items:center;gap:8px;color:var(--muted)}
  input[type=number]{width:120px;background:#0b0e1a;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px;text-align:center}
  .radio{display:flex;gap:12px}
  .btn{cursor:pointer;user-select:none;background:var(--btn);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-weight:600;transition:.15s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-acc{background:linear-gradient(135deg,#1f8ef1 0%,#7dd3fc 100%);border:none;color:#041018}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1022;border:1px solid var(--border);font-size:12px;color:#9aa4bf}
  .stat{font-variant-numeric:tabular-nums}
  .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .progress{height:10px;background:#0b1022;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22d3ee);transition:width .1s}
  .muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <header>
    <h1>Yu-Gi-Oh! 起手期望與條件機率</h1>
    <p class="sub">分類：動點／手坑／成金（抽到再抽一張）／其他。先攻抽 5、後攻抽 6。</p>
  </header>

  <div class="wrap grid">
    <section class="card">
      <h3>設定</h3>
      <div class="row radio">
        <label><input type="radio" name="turn" value="5" checked> 先攻（5 張）</label>
        <label><input type="radio" name="turn" value="6"> 後攻（6 張）</label>
      </div>
      <div class="row two">
        <label>動點 <input id="nS" type="number" min="0" value="10"></label>
        <label>手坑 <input id="nH" type="number" min="0" value="12"></label>
      </div>
      <div class="row two">
        <label>成金 <input id="nG" type="number" min="0" value="3"></label>
        <label>其他 <input id="nO" type="number" min="0" value="15"></label>
      </div>
      <div class="row"><span class="badge" id="deckBadge">牌組總張數：40</span></div>
      <p class="muted">修正版公式：成金提升其他類期望 → E[X≠成金] = (X / (總 - 成金)) × E[T]</p>
    </section>

    <section class="card">
      <h3>期望結果（即時更新）</h3>
      <table>
        <tbody>
          <tr><td>牌組總張數</td><td id="deckN">40</td></tr>
          <tr><td>期望起手總張數</td><td id="eT">5.405</td></tr>
          <tr><td>動點期望</td><td id="eS">1.351</td></tr>
          <tr><td>手坑期望</td><td id="eH">1.622</td></tr>
          <tr><td>成金期望</td><td id="eG">0.405</td></tr>
          <tr><td>其他期望</td><td id="eO">2.027</td></tr>
        </tbody>
      </table>

      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">

      <h3>條件機率：至少 X 動點 & 至少 Y 手坑</h3>
      <div class="row two">
        <label>至少 X 動點 <input id="needS" type="number" min="0" value="1"></label>
        <label>至少 Y 手坑 <input id="needH" type="number" min="0" value="1"></label>
      </div>
      <div class="row">
        <button class="btn btn-acc" id="btnProb">計算機率（10 萬次）</button>
        <span class="badge" id="simInfo">尚未運算</span>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="row" style="margin-top:8px;gap:16px;flex-wrap:wrap">
        <span>機率 ≈ <b id="prob" class="stat">—</b></span>
        <span class="badge">起手 0 手坑 機率：<b id="pZeroH">—</b></span>
        <span class="badge">起手 0 動點 機率：<b id="pZeroS">—</b></span>
      </div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);

function readCounts(){
  const nS = +$('#nS').value||0;
  const nH = +$('#nH').value||0;
  const nG = +$('#nG').value||0;
  const nO = +$('#nO').value||0;
  const deckN = nS + nH + nG + nO;
  $('#deckBadge').textContent = '牌組總張數：' + deckN;
  $('#deckN').textContent = deckN;
  return {nS,nH,nG,nO,deckN};
}

function currentHandN(){
  return +document.querySelector('input[name=\"turn\"]:checked').value;
}

function fmt(x,d=2){return (Math.round(x*10**d)/10**d).toFixed(d);}
function fmt3(x){return (Math.round(x*1000)/1000).toFixed(3);}

function computeExpect(){
  const {nS,nH,nG,nO,deckN}=readCounts();
  const handN=currentHandN();
  if(deckN<=0){['eT','eS','eH','eG','eO'].forEach(id=>$('#'+id).textContent='—');return;}
  if(nG>=deckN){['eT','eS','eH','eG','eO'].forEach(id=>$('#'+id).textContent='∞');return;}
  const eT=handN/(1-nG/deckN);
  const denom=Math.max(1,deckN-nG);
  $('#eT').textContent=fmt3(eT);
  $('#eS').textContent=fmt3((nS/denom)*eT);
  $('#eH').textContent=fmt3((nH/denom)*eT);
  $('#eG').textContent=fmt3((nG/deckN)*eT);
  $('#eO').textContent=fmt3((nO/denom)*eT);
}

function rngShuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}return a;}

function simulateOnce(handN,counts){
  const{nS,nH,nG,nO}=counts;
  const deck=[];
  for(let i=0;i<nS;i++) deck.push('S');
  for(let i=0;i<nH;i++) deck.push('H');
  for(let i=0;i<nG;i++) deck.push('G');
  for(let i=0;i<nO;i++) deck.push('O');
  rngShuffle(deck);
  let toDraw=handN,idx=0,S=0,H=0;
  while(toDraw>0 && idx<deck.length){
    const c=deck[idx++]; toDraw--;
    if(c==='S') S++;
    else if(c==='H') H++;
    else if(c==='G') toDraw++; // 成金補抽
  }
  return {S,H};
}

async function simulateManyAsync(trials,handN,counts){
  const chunk=2000;
  let ok=0, zS=0, zH=0, done=0;
  const bar=$('#bar');
  const t0=performance.now();
  while(done<trials){
    const lim=Math.min(chunk,trials-done);
    for(let i=0;i<lim;i++){
      const r=simulateOnce(handN,counts);
      if(r.S>=needS && r.H>=needH) ok++;
      if(r.H===0) zH++;
      if(r.S===0) zS++;
    }
    done+=lim;
    bar.style.width=(done/trials*100).toFixed(1)+'%';
    await new Promise(r=>setTimeout(r,0));
  }
  const t1=performance.now();
  return {ok,trials,ms:t1-t0,zS,zH};
}

let needS=1,needH=1;
function updateNeedFromInputs(){needS=Math.max(0,+$('#needS').value|0);needH=Math.max(0,+$('#needH').value|0);}

async function runProbability(){
  updateNeedFromInputs();
  const {nS,nH,nG,nO,deckN}=readCounts();
  const handN=currentHandN();
  if(deckN<=0){alert('總張數不可為 0');return;}
  if(nG>=deckN){alert('成金張數不可等於或超過牌組張數');return;}
  const trials=100000;
  const btn=$('#btnProb'); const info=$('#simInfo'); const bar=$('#bar');
  btn.disabled=true; info.textContent='運算中… 0%'; bar.style.width='0%';
  const res=await simulateManyAsync(trials,handN,{nS,nH,nG,nO});
  const p = res.ok/res.trials*100;
  const pZeroH = res.zH/res.trials*100;
  const pZeroS = res.zS/res.trials*100;
  $('#prob').textContent = fmt(p) + '%';
  $('#pZeroH').textContent = fmt(pZeroH) + '%';
  $('#pZeroS').textContent = fmt(pZeroS) + '%';
  info.textContent=`完成：條件機率 ${fmt(p)}% ｜ 0手坑 ${fmt(pZeroH)}% ｜ 0動點 ${fmt(pZeroS)}% ｜ 試行 ${res.trials.toLocaleString()} 次 ｜ ${(res.ms/1000).toFixed(2)} 秒`;
  btn.disabled=false;
}

// 綁定：即時更新（輸入/切換就更新期望值與總張數）
['nS','nH','nG','nO'].forEach(id=>$('#'+id).addEventListener('input',computeExpect));
document.querySelectorAll('input[name=\"turn\"]').forEach(r=>r.addEventListener('change',computeExpect));

// Enter 快捷：在 X/Y 欄位直接觸發運算
$('#needS').addEventListener('keydown',e=>{if(e.key==='Enter')runProbability();});
$('#needH').addEventListener('keydown',e=>{if(e.key==='Enter')runProbability();});
$('#btnProb').addEventListener('click',runProbability);

// 初始顯示
computeExpect();
</script>
</body>
</html>
